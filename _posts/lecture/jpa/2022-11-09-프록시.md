---
title: 프록시
date: 2022-11-09 14:00:00 +0900
categories: [자바 ORM 표준 JPA, 프록시]
isLecture: true
---

<br/>
<br/>
<br/>
<br/>

### 참고

- [자바 ORM 표준 JPA 프로그래밍 - 김영한](https://www.inflearn.com/course/ORM-JPA-Basic/dashboard)

<br/>
<br/>

# 프록시

- EntityManager에는 엔티티 객체를 받아오는 메서드가 두 가지 있다.
  - em.find();
  - em.getReference();
- find()는 알다시피 테이블을 조회해서 엔티티 객체를 만들어 가져오는 메서드이다.
- getReference()는 엔티티의 프록시 객체만을 가져다준다.
  - 실제 엔티티 객체가 아니기 때문에, 호출 직후에 쿼리가 날라가지 않는다.

- 프록시 객체는 실제 엔티티와 똑같이 생긴 빈 껍데기 객체이다.
  - 스프링 AOP에서 본 프록시랑 비슷한 개념이다.
- 실제 엔티티 클래스를 상속 받아 만들어진다.
  - 때문에 겉으로 노출된 동작들은 모두 같다.
  - 사용하는 입장에선 그냥 엔티티 객체를 사용한다고 느껴진다.
- 프록시 객체는 엔티티 객체의 참조를 갖고 있다.
  - 프록시 객체는 엔티티 객체에게 실제 행동을 위임한다.
  - 예를 들어 getName()을 호출하면 연결된 엔티티 객체의 name을 반환한다.
- 프록시 객체는 DB 접근을 최대한 뒤로 미룬다.
  - DB 접근이 필요할 때, 스리슬쩍 갔다온다.

<br/>

![img-description](assets/img/lecture/jpa/proxy-01.png)
_프록시 객체 초기화 과정_

<br/>

0. em.getReference(Member.class, "id1")
   - 멤버의 프록시를 받아온다.
   - DB 조회가 일어나지 않는다.
1. member.getName();
   - 실제 데이터가 필요한 상황이 발생했다.
2. 프록시 객체와 연결된 엔티티가 비어있기 때문에 디비 접근이 필요하다.
3. 이때 진짜 쿼리가 날아간다.
4. 프록시 객체 안에 실제 엔티티가 생성된다.
5. getName() 호출을 엔티티에게 위임하여 응답한다.

<br/>

## 프록시의 특징

- 프록시 객체는 처음 한 번만 초기화 과정을 가진다.
  - 위의 과정을 겪은 member 객체가 다음에 getName() 또는 다른 필드의 get 메서드가 호출돼도
  - 또 초기화를 할 필요가 없다.
- 프록시 객체가 초기화 되었다고 해서 실제 엔티티 객체로 바뀐 것은 아니다.
  - 프록시 객체를 통해서 프록시 객체와 연결된 엔티티 객체에 접근하는 것이다.
- 프록시 객체는 엔티티 클래스를 상속 받은 클래스이다.
  - 타입 비교시에 == 대신 instanceOf 를 사용해야 한다.
- 영속성 컨텍스트 내에 이미 Member 엔티티가 존재 한다면
  - getReference()를 호출해도 실제 엔티티를 반환한다.
  - 이때 주의할 것은 프록시 타입이 아닌 실제 엔티티라는 것이다.
  - == 비교가 가능
- 초기화 되지 않는 프록시 객체가 준영속 상태일 때 DB 접근을 시도하면 예외가 발생한다.
  - org.hibernate.LazyInitializationException 예외가 발생


## 프록시 확인

- 프록시 인스턴스의 초기화 여부 확인
  - emf.getPersistenceUnitUtil()로 PersistenceUnitUtil 객체를 받아올 수 있다.
  - persistenceUnitUtil.isLoaded(entity);
    - 초기화 여부를 boolean 타입으로 반환한다.
- 프록시 클래스 확인
  - proxy.getClass().getName();
- 프록시 강제 초기화
  - org.hibernate.Hibernate.initialize(proxy);
  - JPA 표준에는 강제 초기화가 없다.
  - 강제 호출은 가능 proxy.getColumn();


<br/>
<br/>
<br/>
<br/>

# 즉시로딩과 지연로딩



<br/>
<br/>
<br/>
<br/>
